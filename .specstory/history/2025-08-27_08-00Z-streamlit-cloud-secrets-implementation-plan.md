<!-- Generated by SpecStory -->

# Streamlit Cloud secrets implementation plan (2025-08-27 08:00Z)

_**User**_

# Streamlit Cloud Secrets対応修正仕様書
# OCR Web App - API Key Management Enhancement

project_info:
  name: "OCR Web App"
  version: "3.1.0"
  target_platform: "Streamlit Cloud"
  deployment_url: "https://cursorkadai05-nvwathe43huwrwvlr7zyhd.streamlit.app/"

current_status:
  deployment: "成功"
  api_key_management: "UI入力 + 環境変数/Secrets対応"
  security_level: "中（UI入力あり）"
  target_security_level: "高（Secretsのみ）"

# 修正が必要な理由
modification_rationale:
  security_concerns:
    - "UI上でのAPIキー入力はセキュリティリスク"
    - "APIキーがブラウザの履歴やログに残る可能性"
    - "ユーザーが毎回APIキーを入力する必要がある"
  
  user_experience_issues:
    - "初回利用時のAPIキー入力が煩雑"
    - "APIキーを忘れた場合の再入力が必要"
    - "Streamlit Cloud Secretsの利点を活用できていない"

# 修正対象ファイル
target_files:
  primary:
    - file_path: "src/ui.py"
      function: "render_sidebar()"
      lines: "1305-1375"
      modification_type: "API key input removal"
      risk_level: "medium"
      
  secondary:
    - file_path: "app.py"
      lines: "1-10"
      modification_type: "environment variable handling"
      risk_level: "low"

# 安全な修正手順
modification_steps:
  step_1:
    title: "現在の実装確認"
    description: "src/ui.pyのrender_sidebar()関数の現在の状態を確認"
    current_implementation: |
      # APIキー設定（環境変数から読み込み）
      api_key = os.getenv("GEMINI_API_KEY", "")
      if not api_key:
          api_key = st.secrets.get("GEMINI_API_KEY", "")
      if not api_key:
          api_key = st.text_input(
              "Gemini APIキー",
              type="password",
              help="Google AI Studioから取得したAPIキーを入力してください"
          )
    risk_assessment: "低リスク - 既存の環境変数/Secrets読み込みは維持"

  step_2:
    title: "UI入力部分の削除"
    description: "st.text_input()によるAPIキー入力部分を削除"
    modification: |
      # APIキー設定（環境変数/Secretsからのみ読み込み）
      api_key = os.getenv("GEMINI_API_KEY", "")
      if not api_key:
          api_key = st.secrets.get("GEMINI_API_KEY", "")
      
      # APIキーの状態表示
      if api_key:
          if api_key == "your-api-key-here":
              st.error("⚠️ プレースホルダーのAPIキーが設定されています。実際のAPIキーに変更してください。")
          else:
              st.success("✅ APIキーが設定されています")
    risk_assessment: "中リスク - UI入力の削除により、環境変数/Secretsが必須になる"

  step_3:
    title: "エラーハンドリングの追加"
    description: "APIキーが設定されていない場合の適切なエラー表示"
    modification: |
      else:
          st.error("❌ APIキーが設定されていません")
          st.markdown("""
          **Streamlit Cloud Secrets設定が必要です**:
          
          1. Streamlit Cloud Dashboard にアクセス
          2. アプリの Settings → Secrets を開く
          3. 以下を追加:
          ```
          GEMINI_API_KEY = "実際のAPIキー"
          ```
          """)
    risk_assessment: "低リスク - ユーザーへの明確な指示提供"

  step_4:
    title: "ヘルプセクションの更新"
    description: "UI入力に関する記述を削除し、Secrets設定に特化"
    modification: |
      **APIキー設定方法**:
      1. [Google AI Studio](https://aistudio.google.com/) でAPIキーを取得
      2. Streamlit Cloud Secrets または環境変数 `GEMINI_API_KEY` に設定
      
      **Streamlit Cloud Secrets 設定**:
      1. Streamlit Cloud Dashboard → アプリ → Settings → Secrets
      2. 以下を追加:
      ```
      GEMINI_API_KEY = "実際のAPIキー"
      ```
    risk_assessment: "低リスク - ドキュメント更新のみ"

# 安全性確保のための対策
safety_measures:
  backward_compatibility:
    - "既存の環境変数読み込み機能は維持"
    - "st.secrets.get()による読み込み機能は維持"
    - "APIキー検証機能は維持"
  
  error_handling:
    - "APIキー未設定時の明確なエラーメッセージ"
    - "Streamlit Cloud Secrets設定手順の詳細説明"
    - "APIキー検証機能による設定確認"
  
  testing_strategy:
    - "環境変数設定時の動作確認"
    - "Secrets設定時の動作確認"
    - "APIキー未設定時のエラー表示確認"
    - "APIキー検証機能の動作確認"

# 修正後の期待される動作
expected_behavior:
  with_api_key:
    scenario: "APIキーが環境変数またはSecretsで設定されている場合"
    behavior:
      - "✅ APIキーが設定されています と表示"
      - "APIキー検証ボタンが利用可能"
      - "OCR処理が正常に実行される"
      - "UI上にAPIキー入力フィールドは表示されない"
  
  without_api_key:
    scenario: "APIキーが設定されていない場合"
    behavior:
      - "❌ APIキーが設定されていません と表示"
      - "Streamlit Cloud Secrets設定手順が表示される"
      - "OCR処理は実行できない"
      - "UI上にAPIキー入力フィールドは表示されない"

# リスク評価と対策
risk_assessment:
  high_risk:
    - risk: "APIキー未設定時にアプリが使用不能になる"
      mitigation: "明確な設定手順とエラーメッセージの提供"
      fallback: "必要に応じてUI入力機能の復活"
  
  medium_risk:
    - risk: "既存ユーザーの設定変更が必要"
      mitigation: "Streamlit Cloud Secrets設定手順の詳細説明"
      fallback: "段階的な移行（警告表示から開始）"
  
  low_risk:
    - risk: "コードの複雑性が若干増加"
      mitigation: "適切なコメントとエラーハンドリング"
      fallback: "既存の実装に戻す"

# 実装優先度
implementation_priority:
  critical:
    - "UI入力部分の削除"
    - "エラーハンドリングの追加"
  
  important:
    - "ヘルプセクションの更新"
    - "APIキー状態表示の改善"
  
  optional:
    - "追加のセキュリティ機能"
    - "より詳細な設定手順"

# テスト計画
testing_plan:
  unit_tests:
    - "APIキー読み込み機能のテスト"
    - "エラーハンドリングのテスト"
    - "UI表示のテスト"
  
  integration_tests:
    - "Streamlit Cloud Secrets連携テスト"
    - "環境変数読み込みテスト"
    - "OCR処理フローのテスト"
  
  user_acceptance_tests:
    - "APIキー設定手順の確認"
    - "エラーメッセージの分かりやすさ"
    - "全体的なユーザー体験"

# ロールバック計画
rollback_plan:
  immediate_rollback:
    trigger: "APIキー未設定時にアプリが完全に使用不能"
    action: "UI入力機能を即座に復活"
    time_to_restore: "5分以内"
  
  gradual_rollback:
    trigger: "ユーザーからの設定困難の報告"
    action: "警告表示付きでUI入力機能を復活"
    time_to_restore: "1時間以内"

# 成功指標
success_metrics:
  security:
    - "UI上でのAPIキー入力が完全に削除される"
    - "APIキーがブラウザ履歴に残らない"
    - "Streamlit Cloud Secretsのみで動作する"
  
  usability:
    - "初回設定時の手順が明確"
    - "エラーメッセージが分かりやすい"
    - "APIキー検証機能が正常に動作する"
  
  reliability:
    - "環境変数/Secrets設定時に100%動作"
    - "APIキー未設定時に適切なエラー表示"
    - "既存機能に影響なし"

# 実装スケジュール
implementation_schedule:
  phase_1:
    duration: "30分"
    tasks:
      - "現在の実装確認"
      - "UI入力部分の削除"
      - "基本的なエラーハンドリング追加"
  
  phase_2:
    duration: "15分"
    tasks:
      - "ヘルプセクションの更新"
      - "APIキー状態表示の改善"
  
  phase_3:
    duration: "15分"
    tasks:
      - "テスト実行"
      - "動作確認"
      - "ドキュメント更新"

# 注意事項
important_notes:
  - "この修正はStreamlit Cloud Secrets対応に特化している"
  - "ローカル開発時は.envファイルまたはsecrets.tomlが必要"
  - "既存の環境変数読み込み機能は維持される"
  - "APIキー検証機能は引き続き利用可能"
  - "必要に応じて段階的な実装も可能"

# 関連ドキュメント
related_documents:
  - "README.md - プロジェクト概要"
  - "仕様書.md - 詳細仕様"
  - "requirements.txt - 依存関係"
  - "Streamlit Cloud Secrets Documentation"

---

_**Assistant**_

◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢
Streamlit Cloud Secrets対応修正仕様書の実装を開始します
◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢

[Abstracted Intent]
Original Intent: Streamlit Cloud Secrets対応修正仕様書の実装
Want or Need Intent: UI上でのAPIキー入力を削除し、Streamlit Cloud Secretsのみで動作するようにセキュリティを向上させる

[Goals]
✅ UI上でのAPIキー入力を完全に削除
✅ Streamlit Cloud Secretsのみで動作するように修正
✅ 適切なエラーハンドリングとユーザーガイダンスを追加
✅ 既存の環境変数読み込み機能は維持

[Task Breakdown]
[Task 1] 現在の実装確認 - src/ui.pyのrender_sidebar()関数の状態を確認
[Task 2] UI入力部分の削除 - st.text_input()によるAPIキー入力部分を削除
[Task 3] エラーハンドリングの追加 - APIキー未設定時の適切なエラー表示
[Task 4] ヘルプセクションの更新 - UI入力に関する記述を削除し、Secrets設定に特化

[Agent Execution Stack]
1. Task: 現在の実装確認
   Assigned Agent: Code Analysis Agent
   Description: src/ui.pyのrender_sidebar()関数の現在の状態を確認
   Expected Outcome: 現在のAPIキー管理実装の詳細把握

2. Task: UI入力部分の削除
   Assigned Agent: Code Modification Agent
   Description: st.text_input()によるAPIキー入力部分を削除
   Expected Outcome: UI上でのAPIキー入力が完全に削除される

3. Task: エラーハンドリングの追加
   Assigned Agent: Code Modification Agent
   Description: APIキー未設定時の適切なエラー表示を追加
   Expected Outcome: 明確なエラーメッセージと設定手順の表示

4. Task: ヘルプセクションの更新
   Assigned Agent: Documentation Agent
   Description: UI入力に関する記述を削除し、Secrets設定に特化
   Expected Outcome: 更新されたヘルプセクション

まず、現在の実装を確認して、修正計画を立てます。


---

## Todo List

- [-] 現在の実装確認 - src/ui.pyのrender_sidebar()関数の状態を確認
- [ ] UI入力部分の削除 - st.text_input()によるAPIキー入力部分を削除
- [ ] エラーハンドリングの追加 - APIキー未設定時の適切なエラー表示
- [ ] ヘルプセクションの更新 - UI入力に関する記述を削除し、Secrets設定に特化

---

Read file: undefined

---

現在の実装を確認しました。1308-1317行目でAPIキーの設定が行われており、環境変数→Secrets→UI入力の順で読み込まれています。修正を開始します。


---

## Todo List

- [x] 現在の実装確認 - src/ui.pyのrender_sidebar()関数の状態を確認
- [-] UI入力部分の削除 - st.text_input()によるAPIキー入力部分を削除
- [ ] エラーハンドリングの追加 - APIキー未設定時の適切なエラー表示
- [ ] ヘルプセクションの更新 - UI入力に関する記述を削除し、Secrets設定に特化

---

<details><summary>Edit file: src/ui.py</summary>

undefined

**Chunk 1**
Lines added: 20, lines removed: 7

```diff
@@ -1306,14 +1306,27 @@
          st.header("⚙️ 設定")
          
-         # APIキー設定（環境変数から読み込み）
+         # APIキー設定（環境変数/Secretsからのみ読み込み）
          api_key = os.getenv("GEMINI_API_KEY", "")
          if not api_key:
              api_key = st.secrets.get("GEMINI_API_KEY", "")
-         if not api_key:
-             api_key = st.text_input(
-                 "Gemini APIキー",
-                 type="password",
-                 help="Google AI Studioから取得したAPIキーを入力してください"
-             )
+         
+         # APIキーの状態表示
+         if api_key:
+             if api_key == "your-api-key-here":
+                 st.error("⚠️ プレースホルダーのAPIキーが設定されています。実際のAPIキーに変更してください。")
+             else:
+                 st.success("✅ APIキーが設定されています")
+         else:
+             st.error("❌ APIキーが設定されていません")
+             st.markdown("""
+             **Streamlit Cloud Secrets設定が必要です**:
+             
+             1. Streamlit Cloud Dashboard にアクセス
+             2. アプリの Settings → Secrets を開く
+             3. 以下を追加:
+             ```
+             GEMINI_API_KEY = "実際のAPIキー"
+             ```
+             """)
          
          # APIキーの検証
```

</details>

---

## Todo List

- [x] 現在の実装確認 - src/ui.pyのrender_sidebar()関数の状態を確認
- [x] UI入力部分の削除 - st.text_input()によるAPIキー入力部分を削除
- [x] エラーハンドリングの追加 - APIキー未設定時の適切なエラー表示
- [-] ヘルプセクションの更新 - UI入力に関する記述を削除し、Secrets設定に特化

---

次に、ヘルプセクションを更新して、UI入力に関する記述を削除し、Streamlit Cloud Secrets設定に特化させます。


---

<details><summary>Edit file: src/ui.py</summary>

undefined

**Chunk 1**
Lines added: 8, lines removed: 2

```diff
@@ -1361,6 +1361,12 @@
              **APIキー設定方法**:
              1. [Google AI Studio](https://aistudio.google.com/) でAPIキーを取得
-             2. `.streamlit/secrets.toml` または環境変数 `GEMINI_API_KEY` に設定
-             3. または、上記の入力フィールドに直接入力
+             2. Streamlit Cloud Secrets または環境変数 `GEMINI_API_KEY` に設定
+             
+             **Streamlit Cloud Secrets 設定**:
+             1. Streamlit Cloud Dashboard → アプリ → Settings → Secrets
+             2. 以下を追加:
+             ```
+             GEMINI_API_KEY = "実際のAPIキー"
+             ```
              
              **APIキー取得手順**:
```

**Chunk 2**
Lines added: 1, lines removed: 1

```diff
@@ -1369,5 +1375,5 @@
              3. 「Get API key」をクリック
              4. 新しいAPIキーを作成または既存のキーを選択
-             5. コピーしたAPIキーを設定ファイルに貼り付け
+             5. コピーしたAPIキーをStreamlit Cloud Secretsに設定
              
              **対応形式**: PNG, JPEG, WEBP, HEIC/HEIF
```

</details>

---

## Todo List

- [x] 現在の実装確認 - src/ui.pyのrender_sidebar()関数の状態を確認
- [x] UI入力部分の削除 - st.text_input()によるAPIキー入力部分を削除
- [x] エラーハンドリングの追加 - APIキー未設定時の適切なエラー表示
- [x] ヘルプセクションの更新 - UI入力に関する記述を削除し、Secrets設定に特化

---

修正が完了しました。リンターエラーがないか確認します。


---



---

素晴らしいです！リンターエラーはありません。修正内容を確認するために、変更された部分を再度読み取ります。


---

Read file: undefined

---

◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢
Streamlit Cloud Secrets対応修正が完了しました！
◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢

## 実装完了内容

### ✅ 完了した修正

1. **UI入力部分の削除**
   - `st.text_input()`によるAPIキー入力フィールドを完全に削除
   - 環境変数とStreamlit Cloud Secretsからのみ読み込むように変更

2. **エラーハンドリングの追加**
   - APIキー未設定時の明確なエラーメッセージを追加
   - Streamlit Cloud Secrets設定手順の詳細説明を表示
   - APIキー状態の視覚的表示（✅/❌/⚠️）

3. **ヘルプセクションの更新**
   - UI入力に関する記述を削除
   - Streamlit Cloud Secrets設定手順に特化
   - より詳細な設定ガイダンスを提供

### 🔒 セキュリティ向上

- **UI上でのAPIキー入力が完全に削除**されました
- **APIキーがブラウザ履歴に残るリスクが解消**されました
- **Streamlit Cloud Secretsのみで動作**するようになりました

### �� 修正後の動作

**APIキーが設定されている場合:**
- ✅ "APIキーが設定されています" と表示
- APIキー検証ボタンが利用可能
- OCR処理が正常に実行される

**APIキーが設定されていない場合:**
- ❌ "APIキーが設定されていません" と表示
- Streamlit Cloud Secrets設定手順が表示される
- 明確な設定ガイダンスを提供

### 🛡️ 安全性確保

- 既存の環境変数読み込み機能は維持
- `st.secrets.get()`による読み込み機能は維持
- APIキー検証機能は維持
- 後方互換性を保持

### 📚 更新されたヘルプセクション

- Streamlit Cloud Secrets設定手順の詳細説明
- APIキー取得手順の明確化
- 設定方法の簡素化

この修正により、アプリケーションのセキュリティレベルが「中」から「高」に向上し、Streamlit Cloud Secretsの利点を最大限活用できるようになりました。ユーザーは初回設定時にStreamlit Cloud Secretsを設定するだけで、以降は安全にアプリケーションを利用できます。

---

