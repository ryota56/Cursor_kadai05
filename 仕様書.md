meta:
  project_name: "OCR Web（Streamlit × Gemini API）"
  doc_type: "要件定義書 + 実装計画 (Full Context YAML)"
  version: "1.2.0"
  owners:
    product_owner: "ryota"
    tech_lead: "you (ChatGPT)"
  rationale: >
    画像アップロード→Gemini API OCR→テキスト取得を行うMVPをStreamlitで構築する。
    venv環境構築からライブラリ管理、UI実装、OCR処理、保存機能、テスト計画まで統合。

success_metrics:
  - "PNG/JPEG/WEBPでOCR成功率>=95%"
  - "処理時間: 1枚 <= 60秒"
  - "言語判定妥当率 >=90%"
  - "主要エラーで明確なユーザー指示を返す"

environment:
  runtime: "Python 3.10+"
  framework: "Streamlit"
  python_version_policy:
    min: "3.10"
    recommended: "3.11"
  virtualenv:
    posix:
      create: "python3 -m venv .venv"
      activate: "source .venv/bin/activate"
      deactivate: "deactivate"
    windows:
      create: "py -3 -m venv .venv"
      activate: ".\\.venv\\Scripts\\Activate.ps1"
      deactivate: "deactivate"
    pip_upgrade: "python -m pip install --upgrade pip"
    install_requirements: "pip install -r requirements.txt -c constraints.txt"
  dependencies:
    required:
      - "streamlit>=1.36,<2.0"
      - "google-genai>=0.3.0"
      - "Pillow>=10.3.0"
      - "requests>=2.31.0"
    optional:
      - "pillow-heif>=0.18.0"
      - "python-magic>=0.4.27"
      - "ruff>=0.5.0"
      - "mypy>=1.10.0"
    files:
      requirements_txt: |
        streamlit>=1.36,<2.0
        google-genai>=0.3.0
        Pillow>=10.3.0
        requests>=2.31.0
        # optional
        # pillow-heif>=0.18.0
        # python-magic>=0.4.27
        # ruff>=0.5.0
        # mypy>=1.10.0
      constraints_txt: |
        # 上限/下限を固定して破壊的更新を防ぐ
        # 例: protobuf<6
        # pydantic<3

repository_structure:
  - "app.py"
  - "requirements.txt"
  - "constraints.txt"
  - "README.md"
  - "src/"
  - "src/ocr.py"
  - "src/ui.py"
  - "src/utils/image_io.py"
  - "src/utils/prompts.py"
  - "assets/"
  - ".streamlit/secrets.toml (APIキー管理用)"

functional_requirements:
  upload:
    formats: ["png","jpg","jpeg","webp","heic","heif"]
    multiple: true
    exif_auto_orient: true
    resize: "長辺2048px"
  ocr:
    provider: "Gemini API"
    models: ["gemini-2.5-flash","gemini-2.5-pro"]
    prompt_policy:
      system: "OCRエンジンとして改行・空白整理。ISO639-1で言語コード返却。"
      user_json: "{ \"text\": string, \"language\": string } のJSONで返す"
    output_formats: ["TXT","MD","JSON"]
    files_api_switch: "20MB超で自動切替"
  result_ui:
    - "編集可能なテキストエリア"
    - "コピー・保存ボタン (TXT/MD/JSON)"
    - "言語コード表示"
    - "再実行ボタン"
  error_handling:
    - "未選択警告"
    - "非対応形式警告"
    - "APIキー未設定エラー"
    - "429/5xx自動リトライ（指数バックオフ、最大3回）"
    - "タイムアウト時に縮小提案"

non_functional_requirements:
  performance:
    avg_time_sec: 60
    timeout_api_sec: 60
    timeout_total_sec: 90
  security:
    https: true
    logs: "内容非保存、処理メタのみ"
    secrets: "環境変数 or Streamlit Secrets"
  accessibility:
    ui_lang: "ja"
    font_scalable: true
    keyboard_nav: true

todos:
  m0_skeleton_ui:
    - "リポジトリ初期化 & ディレクトリ作成"
    - "venvセットアップスクリプト作成 (posix/windows)"
    - "requirements/constraintsファイル作成"
    - "Streamlit UI骨組み (サイドバー, アップローダ)"
    - "画像プレビュー/回転補正/リサイズ処理"
  m1_gemini_integration:
    - "APIキーSecrets対応"
    - "google-genaiクライアント初期化"
    - "インライン送信実装"
    - "Files API切替実装"
    - "プロンプトビルダー実装"
    - "JSON出力パース & フォールバック"
  m2_result_handling:
    - "テキスト編集/コピー"
    - "TXT/MD/JSON保存"
    - "再実行導線"
  m3_quality_stabilization:
    - "エラー→ユーザーメッセージ化"
    - "リトライ処理"
    - "タイムアウト制御"
    - "利用ログ出力"
    - "一時ファイル削除"
  m4_accessibility_polish:
    - "フォントサイズ調整"
    - "キーボード操作確認"
    - "UI文言/ヘルプ整理"

qa_test_matrix:
  formats: ["png","jpg","jpeg","webp","heic(要pillow-heif)"]
  sizes: ["1MB未満","5MB","20MB超"]
  languages: ["日本語","英語","混在"]
  quality: ["ぼやけ","低コントラスト","傾き"]
  errors: ["APIキー欠如","429/5xx","タイムアウト"]
  outputs: ["TXT","MD","JSON"]

definition_of_done:
  - "全Milestone達成"
  - "READMEの手順で再現可能"
  - "内容ログ非保存を確認"
  - "代表画像でOCR成功"
  - "失敗時にユーザーが次アクションを取れる"
